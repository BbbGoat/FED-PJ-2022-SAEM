<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Promise 적용연습1</title>
        <script>
            /******************************************************************* 
              [프라미스(Promise)란? "원하는 결과를 보장해! 약속해!"]

                "생성코드"는 시간이 걸릴 수 있는 코드이다.
                "사용코드"는 결과를 기다려야 하는 코드이다.
                Promise는 생성 코드와 사용 코드를 연결하는 JavaScript 객체다!
                __________________________________________________________

                ((구문))
                let 약속변수 = new Promise(function(성공함수, 실패함수) {
                // 생성코드 : 시간이 걸리는 코드

                성공함수(리턴값사용가능); // 성공시호출
                실패함수(리턴값사용가능);  // 에러시 호출
                });

                // 사용코드 : 약속객체가 완료될때까지 기다림!!!
                // then(성공함수,실패함수) 메서드
                약속변수.then(
                function(변수) { 성공시코드 },
                function(변수) { 실패시코드 }
                );
                
                __________________________________________________________

                [ AJAX 비동기 파일처리 전송객체 ]
                AJAX (Asynchronous Javascript And XML)
                -> XMLHttpRequest
                

                1. 특징:
                    (1) 웹서버의 데이터 읽기 (페이지로드후)
                    (2) 페이지로 리로드하지 않고 웹페이지를
                        부분업데이트함
                    (3) 백그라운드 웹서버로 데이터 전송기능

                2. 사용법:
                    (1) 인스턴스를 생성하여 변수에 할당하여 사용
                    예) let ajax = new XMLHttpRequest();

                    (2) 인스턴스를 열어서 전송준비를 한다
                    예) ajax.open("GET","https://my.com/my.pdf")
                    -> open(방식, 요청URL, 아이디, 비번, 비동기옵션)
                    -> 핵심: open(방식, 요청URL)
                        1) 방식: GET / POST
                        -> GET방식이 가볍고 빨라서 더 선호함 
                        -> POST는 보안상 민감한 데이터 처리시 사용!
                        2) 요청URL : 웹서버의 페이지나 파일경로주소
                        3) 아이디/비번 : 서버에 접근시 인증이 필요한 경우 사용
                        4) 비동기옵션 : 기본값은 true -> 비동기 처리
                            -> 아무것도 안쓰면 true로 비동기 처리됨!
                            만약 false라고 하면 동기적처리를 함!
                            -> 비동기적으로 처리해야 페이지가 멈추지 않고
                            요청파일만 별도로 처리한다!
                    
                    (3) 비동기전송 후 처리를 위한 로드함수구역 만들기
                    -> 인스턴스변수.onload = function(){처리소스};
                    -> 여기서 onload라는 것은 서버에서 결과를 로드한다는 의미임!
                    -> 결과처리 상태값은 : 인스턴스변수.status 값으로 한다!

                        [ status 결과상태 종류 ]
                            1) 200 : "OK" - 처리완료됨
                            2) 403 : "Forbidden" - 파일접근거부
                            3) 404 : "Not Found" - 파일없음
                            -> statusText로 받으면 숫자가 아닌, 뒤의 문자형으로 리턴한다!

                        [ response 결과내용 종류 ]
                            1) responseText : 데이터를 문자형식 받기
                            2) responseXML : 데이터를 XML형식 받기
                            3) responseURL : 데이터 전송 URL 받기

                    
                    (4) 오픈 셋팅된 요청객체를 전송한다!
                        인스턴스변수.send()
                        -> open() -> onload -> send() 순으로 코딩

                    [ 웹서버 파일 요청시 주의사항 ]
                    1. 요청한 파일이 현재 페이지의 도메인주소와 다른경우(이종도메인)
                    XSS공격 등의 이유로 브라우저에서 이것을 금지하고 있다!
                    (일반 XMLHttpRequest 요청으로 가져오기는 가능함!)
                    
                    2. Promise를 사용하여 파일을 요청하고 에러발생시
                    이것을 실패함수로 처리할때 이종도메인 에러는 Promise의
                    에러도 발생시키므로 실패함수처리가 되지 않는다!!

                    3. 이것은 근본적인 브라우저 정책이므로 해결방법은
                    같은 도메인의 파일을 요청하는 것이다! (외부도메인 파일을
                    같은 서버에 저장하여 사용하는 경우가 많음!)
                        

         *******************************************************************/

        function 화면뿌려(이거) {
            document.getElementById("show").innerHTML += 이거 + "<br>";
        }

        //////// 로드구역 //////////////////////////////////////
        window.addEventListener("load",()=>{

            // 제이슨 데이터를 로딩하여 읽은 후 데이터를 활용하도록
            // Promise를 적용한다!

            /* 
                [ 제이슨 파일 내부형식에 관하여... ]
                1. 제이슨 파일은 내부형식이 객체형식이지만
                자바스크립트에서 속성명을 변수형으로 쓰는 것처럼
                사용할 수 없다! 반드시 쌍따옴표로 싸서 문자형으로
                표현해야만 한다!

                2. 제이슨 파일 내부에 js주석문은 쓸 수 없다!
                (vscode의 settings.json에서 주석문은 vscode에서
                별도의 처리를 하므로 사용가능했던것임...)

                3. 제이슨은 최상위 형식으로 객체/배열로써 하나만 존재할 수 있다!
                    예) {속성명:값,...} / [{속성명:값,...},{속성명:값,...}]

                4. 제이슨 맨 마지막 항목 뒤에 콤마를 남길 수 없다! (에러)
                -> 자바스크립트에서는 마지막 콤마 허용!
            */

            // 1. 변수 = new Promise((성공함수)=>{코드})
            // 프라미스 코드에 XMLHttpRequest() 객체로 제이슨 로딩함!
            const myProm = new Promise((prFn)=>{ // prFn - 성공함수
                // (1) XMLHttpRequest() 객체 인스턴스 생성하기
                let ajax = new XMLHttpRequest();

                // (2) 비동기 파일요청하기(제이슨파일)
                ajax.open("GET","./defaultSettings.json");
                // -> 제이슨파일은 응답형식(responseType)을 "json"설정필수!
                ajax.responseType = "json";
                // 만약 responseType 설정을 하지 않으면 "text"가 기본값이다!
                // 이런경우엔 제이슨 파일형식이 잘못되었어도 읽어올 수 있다!

                // (3) 결과 리턴 onload 이벤트 함수구역만들기
                ajax.onload = function() {
                    console.log(ajax.status);
                    if (ajax.status == 200) {
                        // 프라미스 성공함수로 제이슨 데이터 전달하기
                        prFn(ajax.response);
                        // responseType을 "json"으로 설정했으므로
                        // 결과값은 제이슨으로 전달된다!
                        
                    } //// if
                    else {
                        console.log(ajax.statusText);
                        // -> 결과값이 null이면 제이슨 파일 내부형식이
                        // 잘못된 경우다! 이런경우 제이슨파일로 취급받지 못해
                        // 아무것도 로딩못한 결과가 나온다!
                    }
    
                }; ///////// onload 함수구역 /////////

                // (4) 비동기 요청보내기 : send()
                ajax.send();
                
            }); ///////// myProm 인스턴스 ///////////////// 

            // 2. 프라미스변수.then((성공전달변수)=>{코드})
            // 성공한 제이슨 로딩 파일을 전달받아 활용한다!
            myProm.then((success)=>{ // success 성공시 전달변수
                console.log("전달파일찍기:",success);

                // html코드만들기
                let hcode = `
                <h2>우리집멍뭉이 정보:<h2>
                <ol>
                    <li>이름 : ${success[0]["멍멍이이름"]}</li>
                    <li>사는곳 : ${success[0]["멍멍이사는곳"]}</li>
                    <li>출신지 : ${success[0]["멍멍이출신지"]}</li>
                    <li>견종 : ${success[0]["견종"]}</li>
                </ol>
                <h2>우리집야옹이 정보:<h2>
                <ol>
                    <li>이름 : ${success[1]["야옹이이름"]}</li>
                    <li>사는곳 : ${success[1]["야옹이사는곳"]}</li>
                    <li>출신지 : ${success[1]["야옹이출신지"]}</li>
                    <li>묘종 : ${success[1]["묘종"]}</li>
                </ol>
                `;

                // 화면출력하기!!!
                화면뿌려(hcode);
                        
            }); ////////// Promise then ///////////
            
        }); /////////////// load //////////////////////////////
        
            
        </script>
        <style>
            @import url("https://fonts.googleapis.com/css2?family=Gamja+Flower&display=swap");
            body {
                background-image: linear-gradient(to bottom, #494949, gray);
                background-repeat: no-repeat;
                background-attachment: fixed;
                text-align: center;
            }
            #show {
                font-family: "Gamja Flower", cursive;
                font-size: 4vw;
                background-image: linear-gradient(to bottom, lightgreen, pink, orangered, aquamarine);
                background-clip: text;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-repeat: no-repeat;
                font-weight: bold;
            }
            #doc{
                width: 50%;
                height: 50vh;
                margin: 0 auto;
            }
        </style>
    </head>
    <body>
        <div id="show"></div>
        <div id="doc"></div>
    </body>
</html>
